(function(d,f){var c="jquery-clip___",a=0,e={width:0,height:0,aspectRatio:0,clipWidth:100,clipHeight:100,$preview:null,onchange:function(j,m,i,l,g,k){},onclip:function(h,g){},oncliperror:function(g){}};d.fn.clip=function(h){var g=d.extend({},e,h);return this.each(function(){var i=d(this).data(c);if(!i){d(this).data(c,i=new b(this,g));i._init();}else{i.options=d.extend({},i.options,h);}});};function b(h,g){this.element=h;this.options=g;}b.prototype={_init:function(){var l=this,i=l.element,g=d(i),k=i.src,h=l.options,j=new Image();this.status=0;this.viewportWidth=0;this.viewportHeight=0;if(g.parent().css("position")==="static"){g.parent().css("position","relative");}l.$wrapper=d('<div class="'+c+'-wrapper"/>').insertAfter(g).css({position:"absolute"});j.onload=function(){l.width=g.width();l.height=g.height();l.displayWidthRatio=j.width/l.width;l.displayHeightRatio=j.height/l.height;l.$wrapper.css({width:g.width(),height:g.height(),left:g.position().left,top:g.position().top});l.$bg=d('<div class="'+c+'-bg"></div>').appendTo(l.$wrapper).hide();l.$viewport=d('<div class="'+c+'-viewport"></div>').appendTo(l.$wrapper).css({display:"none",width:h.width,height:h.height});l.$viewportImg=d('<img src="'+k+'">').appendTo(l.$viewport).css({position:"relative",border:"0","border-radius":"0","vertical-align":"top","max-width":"none","max-height":"none",width:l.width,height:l.height});if(h.$preview&&h.$preview.length){h.$preview.css({position:"relative",overflow:"hidden"});l.$previwImg=d('<img src="'+k+'">').appendTo(h.$preview).css({position:"absolute",width:0,height:0});l.previewWidth=h.$preview.width();l.previewHeight=h.$preview.height();}else{l.$previwImg=d();l.previewWidth=h.clipWidth;l.previewHeight=h.clipHeight;}l._selection();l._move();};j.onerror=function(m){l.options.oncliperror(m);};j.src=g.attr("src");},_selection:function(){var l=this,s=l.options,q=d(l.element),m=0,g=0,i,n,k,r,j,h,p,o;l.$wrapper.mousedown(function(t){l.status=0;g=1;if(m===1){l.$viewport.css({width:0,height:0});}j=l.$wrapper.offset().left,h=l.$wrapper.offset().top,k=t.pageX;r=t.pageY;i=k-j;n=r-h;p=l.width-i;o=l.height-n;return !1;});d(document).mousemove(function(y){if(l.status){return !1;}if(g!==1){return !1;}m=0;l.$bg.show();var u=y.pageX,B=y.pageY,t=u-k,C=B-r,A,z,v,x,w;if(t<0){t=0;}if(C<0){C=0;}A=t;z=C;if(s.aspectRatio&&t&&C){v=A/s.aspectRatio>z/1;t=v?A:z*s.aspectRatio;C=v?A/s.aspectRatio:z;}if(t>p){t=p;C=s.aspectRatio?t/s.aspectRatio:C;}if(C>o){t=s.aspectRatio?C*s.aspectRatio:t;C=o;}l._change(i,n);l.viewportWidth=t;l.viewportHeight=C;return !1;}).mouseup(function(){if(l.status||!g){return !1;}g=0;if(m===1){m=0;l.$bg.hide();l.$viewport.hide();}else{m=1;l._clip(i,n);}return !1;});},_move:function(){var l=this,h=0,k,n,g,i,m,j,o;l.$viewport.mousedown(function(p){l.status=1;h=1;j=p.pageX;o=p.pageY;k=j-l.$viewport.offset().left;n=o-l.$viewport.offset().top;g=l.$wrapper.offset();return !1;});d(document).mousemove(function(q){if(!l.status||!h){return !1;}i=q.pageX-k-g.left;m=q.pageY-n-g.top;var p=l.width-l.viewportWidth,r=l.height-l.viewportHeight;if(i<0){i=0;}if(i>p){i=p;}if(m<0){m=0;}if(m>r){m=r;}l._change(i,m);}).mouseup(function(){if(!l.status||!h){return !1;}h=0;l._clip(i,m);});},_change:function(i,k){var m=this,l,g,h,j;m.$viewport.css({display:"block",width:m.viewportWidth,height:m.viewportHeight,left:i,top:k});m.$viewportImg.css({left:-i,top:-k});l=m.previewWidth/m.viewportWidth;g=m.previewHeight/m.viewportHeight;m.$previwImg.css({width:m.width*l,height:m.height*g,left:-i*l,top:-k*g});i=i*m.displayWidthRatio;h=i+m.viewportWidth*m.displayWidthRatio;k=k*m.displayHeightRatio;j=k+m.viewportHeight*m.displayHeightRatio;m.options.onchange.call(m.element,i,k,h,j,m.previewWidth,m.previewHeight);},_clip:function(i,o){var m=this,l=m.element,j,h,k,g,p;i=i*m.displayWidthRatio;o=o*m.displayHeightRatio;g=m.viewportWidth*m.displayWidthRatio;p=m.viewportHeight*m.displayHeightRatio;j=d("<canvas></canvas>").appendTo("body").attr({width:m.previewWidth||g,height:m.previewHeight||p})[0];h=j.getContext&&j.getContext("2d");try{h.drawImage(l,i,o,g,p,0,0,m.previewWidth||g,m.previewHeight||p);k=j.toDataURL();m.options.onclip.call(m.element,m._dataURL2Blob(k),c+".png");d(j).remove();}catch(n){m.options.oncliperror.call(m.element,n);d(j).remove();}},_dataURL2Blob:function(l){var m=atob(l.split(",")[1]),g=l.split(",")[0].split(":")[1].split(";")[0],k=new ArrayBuffer(m.length),h=new Uint8Array(k),j=0;for(;j<m.length;j++){h[j]=m.charCodeAt(j);}return new Blob([k],{type:g});}};})(jQuery);