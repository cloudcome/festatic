/*!
 * jquery.fn.upload.js
 * @author ydr.me
 * @version 1.1
 */
(function(e,h,c){var j,i=h.document,g=i.body,a=i.createElement("input").files===null||"files" in i.createElement("input"),b=!!window.FormData,l=a&&b,f=function(){},k={"image/png":"png","image/jpeg":"jpg","image/gif":"gif","text/plain":"txt"},d={action:"",data:null,inputName:"file",minSize:0,maxSize:1048576,fileType:["png","jpg","jpeg","gif"],errorMsg:{singleError:"第{n}个文件上传错误或失败",multiError:"上传错误或失败",singleNone:"尚未选择第{n}个上传文件",multiNone:"尚未选择任何上传文件",empty:"待上传文件为空",type:"第{n}个文件类型不符合要求",size:"第{n}个文件容量不符合要求"},oncomplete:f,onsuccess:f,onerror:f,onprogress:f};e.support.inputFiles=a;e.support.formData=b;e.fn.upload=function(o){var v=e.extend({},d,o),t=[],m=[],q=0,s=0,n=this.length,r=0,p=0;return this.each(function(H){var x,D=0,F,J,E=0,C=0,B=0,z,G=this,y;if(l){t=[];y=new FormData();x=G.files;C=x.length;for(;E<C;E++){z=x[E];F=I(z);J=w(z);if(F&&J){B++;y.append(v.inputName+"_"+E,z);}else{if(!F){t.push(u("type",E));}else{if(!J){t.push(u("size",E));}}}}if(!C){t.push(u("multiNone",0));D=1;}else{if(B){A(y);}else{t.push(u("empty",0));D=1;}}if(t.length){v.onerror(t);}if(D){v.oncomplete();}}else{F=I(G);J=w(G);if(F&&J){K(G);}else{if(G.value===""||G.value===c||G.value===null){t.push(u("singleNone",H));s++;p++;}else{if(!F){t.push(u("type",H));s++;p++;}}}if(p+r==n){v.onerror(t);v.oncomplete();}}function I(M){var N="",O="";if(l){N=k[M.type]||"";}else{O=M.value;if(O!==""){N=(O.match(/\.([^\.]*)$/)||["",""])[1];}}return e.inArray(N.toLowerCase(),v.fileType)>=0;}function w(N){var M=1;if(l){M=N.size;}return M>=v.minSize&&M<=v.maxSize;}function L(M,N){var O="";M&&e.each(M,function(S,R){var Q=String(S),P=String(R);if(l){N.append(Q,P);}else{O+='<input type="hidden" name="'+Q+'" value="'+P+'" />';}});return l?N:O;}function A(N){var O=new XMLHttpRequest(),M=0;N=L(v.data,N);O.onloadend=v.oncomplete;O.onload=function(){var P,Q={};if(O.readyState==4){if(!M&&O.status==200){M=1;P=O.responseText;if(P!==""){try{Q=e.parseJSON(P);}catch(R){}}e.isEmptyObject(Q)?v.onerror([u("multiError",0)]):v.onsuccess(Q);}else{v.onerror(["上传出现"+O.status+"错误！"]);}}};O.onerror=function(){v.onerror([u("multiError",0)]);};O.upload.onprogress=function(P){v.onprogress(P);};O.open("post",v.action);O.send(N);}function K(T){var V,Q=e(T),P=Q.attr("name"),S,U=v.inputName+"_"+H,R=0,O=(new Date().getTime())+"-"+((Math.random()+"").replace(".","")),W=e('<iframe src="javascript:false" name="iframe-name-'+O+'" style="display:none;"></iframe>').appendTo(g),X=e('<form action="'+v.action+'" method="post" enctype="multipart/form-data" target="iframe-name-'+O+'" style="display:none;"></form>').appendTo(g),M=e('<input type="submit">').appendTo(X);X.append(L(v.data));S=Q.clone(true,true).insertAfter(T);Q.removeAttr("id").appendTo(X);Q.attr("name",U);if(!R){W.load(function(){var Z=e(this).contents().find("body").html(),Y={};N();if(Z!==""){try{Y=e.parseJSON(Z);}catch(aa){}}if(e.isEmptyObject(Y)){p++;s++;t.push(u("singleError",0));}else{r++;q++;m.push(Y);}if(q+s==n){if(s==p){v.onerror(t);}if(q==r){v.onsuccess(m);}v.oncomplete();}}).error(function(){N();p++;s++;t.push(u("singleError",0));if(q+s==n){if(s==p){v.onerror(t);}v.oncomplete();}});}function N(){Q.attr("name",P);Q.insertBefore(S);S.remove();W.remove();X.remove();R=1;}M.trigger("click");}});function u(x,w){return v.errorMsg[x].replace("{n}",w+1);}};e.fn.upload.defaults=d;e.fn.upload.addTypeRelationship=function(m,o){var n=e.type(m);if(n=="object"){k=e.extend({},k,m);}else{if(n=="string"){k[m]=o;}}return k;};})($,this);